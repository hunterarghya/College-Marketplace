<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>My Items</title>
  </head>
  <body>
    <button onclick="location.href='/static/feed.html'">
      Back to Marketplace
    </button>
    <h1>My Items</h1>

    <div id="mine"></div>

    <script>
      const apiBase = "";
      function authHeaders() {
        const t = localStorage.getItem("token");
        return t ? { Authorization: "Bearer " + t } : {};
      }

      async function load() {
        const mineDiv = document.getElementById("mine");
        mineDiv.innerHTML = "";

        // Get user info
        const meRes = await fetch(apiBase + "/auth/me", {
          headers: authHeaders(),
        });
        if (!meRes.ok) {
          mineDiv.innerHTML = "Failed to load profile.";
          return;
        }
        const me = await meRes.json();

        // Get feed posts
        const res = await fetch(apiBase + "/feed", { headers: authHeaders() });
        const posts = await res.json();

        posts.forEach((p) => {
          const isMine =
            (p.user_id && p.user_id === me.id) ||
            (p.user && p.user.email === me.email);

          if (!isMine) return;

          const div = document.createElement("div");
          div.style.border = "1px solid #000";
          div.style.margin = "8px";
          div.style.padding = "8px";

          div.innerHTML = `
      <h3>${p.title}</h3>
      ${p.url ? `<img src="${p.url}" style="max-width:200px;">` : ""}
      <p>${p.description || ""}</p>
      <div>Price: ${p.price}</div>
      <div>Location: ${p.location}</div>
      <div>Status: ${p.status}</div>
      <div>Created: ${p.created_at}</div>
    `;

          // EDIT BUTTON
          const editBtn = document.createElement("button");
          editBtn.innerText = "Edit";
          editBtn.onclick = () =>
            (location.href = "/static/edit_post.html?id=" + (p.id || p.uuid));
          div.appendChild(editBtn);

          // DELETE BUTTON
          const delBtn = document.createElement("button");
          delBtn.innerText = "Delete";
          delBtn.onclick = async () => {
            if (!confirm("Delete this post?")) return;
            const r = await fetch(apiBase + "/post/" + (p.id || p.uuid), {
              method: "DELETE",
              headers: authHeaders(),
            });
            if (!r.ok) return alert("Delete failed");
            alert("Deleted successfully!");
            load();
          };
          div.appendChild(delBtn);

          mineDiv.appendChild(div);
        });
      }
      load();
    </script>
  </body>
</html>
